{% extends '::base.html.twig' %}

{% macro displayStep(step, objects, deep) %}
{% spaceless %}
<div class="{% if deep == 0 %}root{% else %}step{% endif %}">
    <span class="step-content">
    <div class="step-title">{{ step.title }}</div>
    {% for obj in objects %}
      {% if obj.step.title == step.title %}
        <span class="game-object" data-toggle="tooltip" title="{{ obj.name }}">
          <img src="{{ asset('img/icons/lame.png') }}" class="draggable" data-id="{{ obj.id }}" alt="">
          {% if obj.unlocked %}
              <a href="#" class="btn btn-default btn-xs" data-id="{{ obj.id }}">
                <img src="{{ asset('img/icons/accept.png') }}" alt="">{{ obj.cost }}
              </a>
          {% else %}
            <a href="#" class="btn btn-default btn-xs unlock-object" data-id="{{ obj.id }}">
                <img src="{{ asset('img/icons/add.png') }}" alt="">{{ obj.cost }}
            </a>
          {% endif %}
        </span>
      {% endif %}
    {% endfor %}
    </span>

    {% if step.children|length %}
      <div class='lvl{{ deep }} level'>
        {% for child in step.children %}
          {{ _self.displayStep(child, objects, deep + 1) }}
        {% endfor %}
      </div>
    {% endif %}
</div>
{% endspaceless %}
{% endmacro %}

{% block body %}

<div class="container">
  {% include 'ZniehVillageGameBundle:Public:listBuilding.html.twig'  with { 'buildings' : buildings, 'active' : building.title } %}
  <h2>{{ building.title }}</h2>
  <p>{{ building.description }}</p>
</div>


<div class="row">
  <div id="droppable" class="col-lg-2" style="background: brown; margin-left: 20px">
    Création d'armes :
    {{ form(form) }}

    Vos armes enregistrées :
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus feugiat velit ac tortor dictum pharetra. Sed in dolor ac eros facilisis semper. Praesent congue neque id libero rhoncus hendrerit. Ut accumsan sem ut velit condimentum mollis. Sed iaculis enim eu dolor vestibulum, et mattis elit scelerisque. Etiam vel ipsum nulla. Nunc egestas elit sed metus pulvinar blandit. Donec in ligula imperdiet, ultrices tellus non, dignissim ipsum.

  </div>
  <div class="col-lg-9">
    <div>
      {% for step in steps %}
      <div style="margin-bottom: 70px">
        {% if step.parent == null %}
          {{ _self.displayStep(step, objects, 0) }}
        {% endif %}
      </div>
      <div class="clearfix"></div>
      {% endfor %}
    </div>
  </div>
</div>


{% endblock %}


{% block stylesheets %}
 {{ parent() }}
  <style>
  *, *:before, *:after {
    -webkit-box-sizing: initial;
    -moz-box-sizing: initial;
    box-sizing: initial;
  }
  .root {
    position: relative;
  }
  .level {
    margin-left: 400px;
    position: relative;
  }
  .level:before {
    content: "";
    width: 50px;
    border-top: 2px solid #eee9dc;
    position: absolute;
    left: -98px;
    top: 50%;
    margin-top: 1px;
  }
  .step {
    min-height: 100px;
    position: relative;
  }
  .step:before {
    content: "";
    height: 100%;
    border-left: 2px solid #eee9dc;
    position: absolute;
    left: -48px;
  }
  .step:after {
    content: "";
    width: 46px;
    border-top: 2px solid #eee9dc;
    position: absolute;
    left: -46px;
    top: 50%;
    margin-top: 1px;
  }
  .step:first-child:before {
    width: 10px;
    height: 50%;
    top: 50%;
    margin-top: 2px;
    border-top-left-radius: 10px;
  }
  .step:first-child:after {
    height: 10px;
    border-top-left-radius: 10px;
  }
  .step:last-child:before {
    width: 10px;
    height: 50%;
    border-bottom-left-radius: 10px;
  }
  .step:last-child:after {
    height: 10px;
    border-top: none;
    border-bottom: 2px solid #eee9dc;
    border-bottom-left-radius: 10px;
    margin-top: -11px;
  }
  .step:only-child:before {
    border-top: none;
    border-bottom: none;
    content: none;
    margin-top: 0px;
  }
  .step:only-child:after {
    width: 52px;
    left: -52px;
    top: 52%;
  }
  .step-content {
    width: 280px;
    padding: 5px 10px;
    border: 2px solid #eee9dc;
    border-radius: 5px;
    display: block;
    position: absolute;
    left: 0;
    top: 50%;
    margin-top: -15px;
    background-color: brown;
  }
  .game-object {
    padding: 5px 5px 5px 5px;
    width: 50px;
    height: 20px;
  }
  .game-object img{
    margin-right: 3px;
  }
</style>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
	<script>
    $('.unlock-object').on('click', function(e){
        e.preventDefault();
        var id = $(this).data("id");
        var obj = $(this);
        $.get('http://localhost/znieh/web/app_dev.php/village/unlock/' + id)
        .done(function(data){
          console.log('done');
          obj.children().attr("src", '{{ asset('img/icons/accept.png') }}');
        })
        .fail(function(e) {
          console.log('fail');
        });
    });
    $(document).ready(function(){
        $('.game-object').tooltip();
        var form = $('#znieh_unitgamebundle_weapon');
        $( ".draggable" ).draggable();
        $( "#droppable" ).droppable({
              drop: function( event, ui ) {
                  console.log(event);
                  console.log(ui);
                  console.log(ui.draggable.data("id"));
                  console.log($('#znieh_unitgamebundle_weapon_parts_' + ui.draggable.data("id")));
                  $('#znieh_unitgamebundle_weapon_parts_' + ui.draggable.data("id")).prop('checked', true);
              }
        });
    });

	</script>
{% endblock %}
