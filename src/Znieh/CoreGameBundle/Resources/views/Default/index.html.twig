{% extends "ZniehCoreGameBundle::layout.html.twig" %}

{% block initCreateJS %}
onload="init();"
{% endblock %}

{% block createJs %}

<script src="{{ asset('js/game/XNARectangle.js') }}"></script>
<script src="{{ asset('js/game/Tile.js') }}"></script>
<script src="{{ asset('js/game/Map.js') }}"></script>
<script src="{{ asset('js/game/Unit.js') }}"></script>
<script src="{{ asset('js/game/contentManager.js') }}"></script>

<style>
.sprite {
  overflow: hidden;
  width: 32px;
  height: 32px;
  float: left;
}
</style>

<script>

var canvas = document.getElementById("canvas");
var stage = new createjs.Stage(canvas);
stage.enableMouseOver();
function init() {
  contentManager = new ContentManager(stage, 480, 480);
  contentManager.init();
}

var nextUnitID = 0;
var units = [
  { "sprite": "firefox", "taille": "petitfin", "name": "Bobby", "statut": 0 },
  { "sprite": "firefox", "taille": "grandmuscle", "name": "Jacky", "statut": -1 },
  { "sprite": "mailarmor", "taille": "petitfin", "name": "Patrick", "statut": -1 }
];

var left = true;

$(document).ready(function(){
  for (var i = units.length - 1; i >= 0; i--) {
    if(units[i].taille == "petitfin") {
      taille = "";
      coef = 1;
    }
    else{
      taille = "2";
      coef = 2;
    }

    $("#myUnits").prepend('<a class="list-group-item clearfix" id="unit-'+ i +'" data-unit="'+ i +'"><div style="overflow: hidden; width: ' + 32 * coef + 'px; height: ' + 32 * coef + 'px; float: left;"><img src="" alt="" id="unit-'+i +'-img"/></div> <div style="margin-top:5px; font-weight: bold; ">' + units[i].name + '</div></a>');
    $("#unit-" + i).on("click", {id: i}, function(event) {
      if(units[event.data.id].statut == -1) {
        $("#myUnits a").removeClass("active");
        for (var i = units.length - 1; i >= 0; i--) {
          if(units[i].statut == 0)
            units[i].statut = -1;
        };
        $("#unit-" + event.data.id).addClass("active");
        units[event.data.id].statut = 0;
      }
    });
  }
  $("#myUnits :first-child").addClass("active");
});

mySide = '<h2>Mes unités</h2><div class="list-group" id="myUnits"></div>';

ennemySide = '<h2>Unités ennemies</h2><div class="list-group" id="ennemyUnits"></div>';

if(left) {
  leftPart = mySide;
  rightPart = ennemySide;
}
else {
  leftPart = ennemySide;
  rightPart = mySide;
}

$("#leftSide").html(leftPart);
$("#rightSide").html(rightPart);

</script>

{% endblock %}

{% block body %}

  <div class="row">
    <div class="col-sm-2" id="leftSide">
    </div>
    <div class="col-sm-8">
      <canvas id="canvas" width="480" height="480" style="margin:0px;"> Canvas not supported. Please update your browser. </canvas>
      <div id="fps" style="font-size:12px; margin:0px; padding:0px;"></div>
    </div>
    <div class="col-sm-2" id="rightSide">
    </div>
  </div>

  <button id="join" type="button" class="btn btn-primary">Join pool</button>
  <button id="ready" type="button" class="btn btn-primary">Ready <em>(start search)</em></button>

  <p><br />
    Pool ID : <input type="text" id="poolId" value="0" /></input>
  </p>

  <br /><br />
  <pre id="console" style="border: 1px dotted grey; padding: 10px;width: 600px;"><strong>Console Log :</strong><br /><br /></pre>

  <div id="pools" style="border: 1px dotted grey; width: 600px; padding: 10px;">
    <button id="fight" type="button" class="btn btn-primary">Fight !</button>
  </div>

{% endblock %}

{% block javascripts %}

  {{ parent() }}

  <script>

    var socket = undefined;

    socket = io.connect('127.0.0.1:1337');
    $('#console').append('Connected<br>');


    // In
    socket.on('welcome', function (data) {
      console.log(data);
      $('#console').append('Server has send welcome message. Your name is : ' + data + '<br />');
    });

    socket.on('service', function (data) {
      console.log(data);
      $('#console').append('Service message : ' + data.msg + '<br />');
    });

    socket.on('players', function (data) {
      console.log(data);
      $('#console').append('Current players : ' + data.players + '<br />');
    });

    socket.on('pools-list', function (data) {
      console.log(data);
      $('#pools').html(JSON.stringify(data));
    });


    // Out
    $('#join').click(function () {
      socket.emit('join', {pool: $('#poolId').val()});
      $('#console').append('<strong>Trying to join pool...</strong><br>');
    });

    $('#auth').click(function () {
      socket.emit('auth', { username: '{{ app.user.username }}' , token: '{{ app.user.token }}' });
      $('#console').append('<strong>Trying to auth...</strong><br>');
    });

    $('#ready').click(function () {
      socket.emit('ready', null);
      $('#console').append('<strong>Ready to fight. Looking for a game...</strong><br>');
    });

    $('#fight').click(function () {
      socket.emit('get-pools', null);
      $('#pools').html('<strong>Loading ...</strong><br>');
    });

  </script>

{% endblock %}
