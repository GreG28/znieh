<html>

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.1/css/bootstrap.min.css">
<style type="text/css">
body { padding: 15px; }
</style>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="http://127.0.0.1:1337/socket.io/socket.io.js"></script>
<script type="text/javascript" src="http://momentjs.com/downloads/moment-with-langs.min.js"></script>
<script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>

<button id="auth" type="button" class="btn btn-primary">Auth</button>
<button id="join" type="button" class="btn btn-primary">Join pool</button>
<button id="ready" type="button" class="btn btn-primary">Ready <em>(start search)</em></button>

<p><br />
  Username : <input type="text" id="username" value="alfo" /><br />
  Pool ID : <input type="text" id="poolId" value="0" /></input>
</p>

<h2>Chat</h2>
Target : <input type="text" id="target" value="test" /><br />
Message : <input type="text" id="msg" value="Hello, World." />
<button id="send" type="button" class="btn btn-primary">Send</button>

<div class="tabbable" id="chat">
  <ul class="nav nav-tabs" id="chat-conversations"></ul>
  <div class="tab-content" id="chat-messages"></div>
</div>

<br /><br />
<pre id="console" style="border: 1px dotted grey; padding: 10px;width: 600px;"><strong>Console Log :</strong><br /><br /></pre>

<div id="pools" style="border: 1px dotted grey; width: 600px; padding: 10px;">
  <button id="fight" type="button" class="btn btn-primary">Fight !</button>
</div>


<script>
	var socket = undefined;
  var conversations = [];

  socket = io.connect('127.0.0.1:1337');
  $('#console').append('Connected<br>');


  // In
  socket.on('welcome', function (data) {
    console.log(data);
    $('#console').append('Server has send welcome message. Your name is : ' + data + '<br />');
  });

  socket.on('service', function (data) {
    console.log(data);
    $('#console').append('Service message : ' + data.msg + '<br />');
  });

  socket.on('players', function (data) {
    console.log(data);
    $('#console').append('Current players : ' + data.players + '<br />');
  });

  socket.on('pools-list', function (data) {
    console.log(data);
    $('#pools').html(JSON.stringify(data));
  });




  // Out
  $('#join').click(function () {
    socket.emit('join', {pool: $('#poolId').val()}, function(){});
    $('#console').append('<strong>Trying to join pool...</strong><br>');
  });

  $('#auth').click(function () {
    socket.emit('auth', {username: $("#username").val() , token: 'abc'}, function(){});
    $('#console').append('<strong>Trying to auth...</strong><br>');
  });

  $('#ready').click(function () {
    socket.emit('ready', null, function(){});
    $('#console').append('<strong>Ready to fight. Looking for a game...</strong><br>');
  });

  $('#fight').click(function () {
    socket.emit('get-pools', null, function(data) {
      $('#pools').html(JSON.stringify(data));
    });
    $('#pools').html('<strong>Loading ...</strong><br>');
  });


  /* CHAT SERVER */

  var addConversation = function(from) {
  conversations[conversations.length] = from;
  var index = conversations.length - 1;

  $('#chat-conversations')
    .append('<li class="chat-conversation"><a href="#tab' + index + '" data-toggle="tab">' + from + '</a></li>');
  $('#chat-messages').append('<div class="tab-pane" id="tab' + index + '"><p class="chat-message"></p><input type="text" class="form-control chat-input" id="chat-input-' + index + '" placeholder="Entrez votre message..."/></div>');

  if(conversations.length == 1) {
    $('#chat-conversations > li').addClass('active');
    /*$('#chat-conversations > li > a').each(function() {
    var elem = $(this);
    setInterval(function() {
        if (elem.css('background-color') == 'rgb(66, 139, 202)') {
            elem.css('background-color', 'rgb(255, 255, 255)');
            elem.css('color', 'rgb(0, 0, 0)');
        } else {
            elem.css('background-color', 'rgb(66, 139, 202)');
            elem.css('color', 'rgb(255, 255, 255)');
        }    
      }, 200);
    });*/
    $('#chat-messages > div').addClass('active');
  }

  $('#chat-input-' + index).keyup(function(e){
    if(e.keyCode == 13)
    {
      var date = moment().calendar();
      $('#tab' + index + ' > p').append('['+date+'] -> '+conversations[index]+': '+$('#chat-input-' + index).val()+'<br />');
      socket.emit('message', {target: conversations[index], msg: $('#chat-input-' + index).val()}); 
      $('#chat-input-' + index).val('');
    }
  });

  return index;
};

socket.on('message', function (data) {
  var index = undefined;

  for (var i = 0; i < conversations.length; i++) {
    if(conversations[i] == data.from) index = i;
  }

  if(index == undefined) index = addConversation(data.from);
  
  date = moment(data.date, "X").calendar();
  $('#tab' + index + ' > p').append('['+date+'] '+data.from+' -> '+data.to+': '+data.msg+'<br />');
  
  $('#console').append('<strong>['+date+'] '+data.from+' -> '+data.to+': '+data.msg+'</strong><br />');

});




  // Out
  $('#send').click(function () {
    var index = undefined;

    for (var i = 0; i < conversations.length; i++) {
      if(conversations[i] == $('#target').val()) index = i;
    }

    if(index == undefined) index = addConversation($('#target').val());

    date = moment().calendar();
    $('#tab' + index + ' > p').append('['+date+'] -> '+$('#target').val()+': '+$('#msg').val()+'<br />');

    socket.emit('message', {target: $('#target').val(), msg: $('#msg').val()}); 
    $('#msg').val('');
  });


</script>


</html>
